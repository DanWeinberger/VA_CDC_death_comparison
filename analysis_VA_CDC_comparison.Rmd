---
title: "Compare excess death in VA and CDC data"
author: "Dan Weinberger"
date: "3/15/2022"
output:
  html_document:
    df_print: paged
    html_document: null
    toc: yes
    toc_depth: 2
    toc_float: yes
  word_document:
    toc: yes
    toc_depth: '2'
  pdf_document: 
    keep_tex:  true
params:
  agg.level: 'state'
  n.days.filter: 20
  web.version: FALSE
  extrap.date: '2020-01-26'
  count.start.date: '2020-03-01'
  end.data.date: '2020-09-05'
---

```{r setup, include = F}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo=F,
  warning=FALSE, 
  message=FALSE,
  comment = "#>",
  dev=c('png','pdf'),
  fig.path='./figures/',
  gganimate = list(
    nframes = 50)
)

library(readxl)
library(reshape2)
library(ggplot2)
library(lubridate)
library(RColorBrewer)
library(plotly)
library(MMWRweek)
library(readr)
library(rjson)
library(parallel)
library(htmlTable)
library(RSocrata)
library(pdftools)
library(readr)
library(patchwork)
library(abind)
library(INLA)
library(gsubfn)
library(dplyr)
library(RCurl)
library(dplyr)
library(tidyverse)
library(gridExtra)
library(gifski)
library(gganimate)
library(shiny)
library(INLA)
library(lme4)

library(pbapply)
#library(jsonlite)
set.seed(123)

source('./R/read_dependent_scripts.R')

```

RACE RECODE:
 1=White
 2=Black
 3=American Indian
 4=Asian
 5=Hawaiian/Pacific Islanders

```{r}
cdc<- readRDS('./outputs/summary_list_cdc.rds')

va.full <- readRDS('./outputs/confidential/outputs_all/summary_list_va.rds')

va.users <- readRDS('./outputs/confidential/outputs_users/summary_list_va.rds')

```

NOTE TO SELF: Alternative INLA model is fit to the entire dataset and explicitly estimates quarterly change from baseline. Use call_inla_full_ds.R and inla_model_full_ds1.R


## Observed and expected incidence by age


```{r, fig.width=7, fig.height=5}

 va.users$preds.age.overall$source <- 'va.users'
 va.full$preds.age.overall$source <- 'va.full'

all.inc <- bind_rows( va.full$preds.age.overall, va.users$preds.age.overall, cdc$preds.age.overall)

all.inc2 <- bind_rows( va.full$preds.age.overall, va.users$preds.age.overall, cdc$preds.age.overall)

all.inc2$exp_inc <- all.inc2$obs_inc-all.inc2$excess_inc_median

all.inc2.m <- melt(all.inc2[,c('agec','source','exp_inc','obs_inc')], id.vars=c('agec','source'))

all.inc2.m$agec2 <- NA
all.inc2.m$agec2[all.inc2.m$agec=="25-44 years"] <- 1
all.inc2.m$agec2[all.inc2.m$agec=="45-64 years"] <- 2
all.inc2.m$agec2[all.inc2.m$agec=="65-74 years"] <- 3
all.inc2.m$agec2[all.inc2.m$agec=="75-84 years"] <- 4
all.inc2.m$agec2[all.inc2.m$agec=="85 years and older"] <- 5

age.labs1 <- c("25-44 years","45-64 years" ,"65-74 years","75-84 years","85 years and older")
all.inc2.m$agec2[all.inc2.m$variable=='exp_inc'] <- all.inc2.m$agec2[all.inc2.m$variable=='exp_inc'] - 0.1

all.inc2.m$pair1 <- as.numeric(as.factor(paste(all.inc2.m$agec, all.inc2.m$source)))

ggplot(all.inc2.m, aes(x=agec2, y=log(value),color=source, shape=variable))+
  geom_point() +
  scale_shape_manual(values=c(1,19))+
  geom_line(aes(group = pair1))+
guides(shape = 'none')+ #To turn off shape legend
  theme_classic()+
  scale_x_continuous( breaks = c(1:5),  label = age.labs1)+
  #theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle('Observed vs expected Incidence in 2020 (open symbol=expected)')+
  ylab('Log(Incidence)')+
  xlab("")
```


Excess incidence vs expected incidence
Each color is a different age, each symbol a different group
Crosses are VA users
```{r}
plot(log( all.inc$pred_inc_median),log(all.inc$excess_inc_median), col=as.factor(all.inc$agec), pch=as.numeric(as.factor(all.inc$source)))
```

```{r, fig.width=8, fig.height=8}
#plot(va.users$preds.age_race$excess_inc_median)

ggplot(va.users$preds.age_race, aes(x=date, y=excess_inc_median)) +
  geom_line() +
  geom_hline(yintercept=0)+
  theme_classic()+
  ggtitle('Excess Incidence (cases/100,000) by race and age')+
  facet_grid(agec~race_recode, scales='free')
  

ggplot(va.users$preds.age_race, aes(x=date, y=excess_inc_median*pop)) +
  geom_line() +
  geom_hline(yintercept=0)+
  theme_classic()+
  ggtitle('Excess Cases (N) by race and age')+
  facet_grid(agec~race_recode, scales='free')
  

#plot(va.users$preds.age_race$excess_inc_median)

ggplot(cdc$preds.age_race, aes(x=date, y=pop)) +
  geom_line() +
  theme_classic()+
  facet_wrap(agec~race_recode, scales='free')+
  ggtitle('Population size by age and race')
```



## Observed vs expected CDC 

```{r fig.width=8, fig.height=2}
cdc$fit.plots$p1

t2 <- cdc$fit.plots$p1

t2.cdc <- t2 +
  facet_wrap(~agec, scales='free', nrow=1)+
    theme(legend.position="none")+
  ylab('Deaths/100000')+
    ggtitle('General US population')

t2.cdc
```

CDC population 
```{r}
plot(cdc$preds.age$date, cdc$preds.age$pop)
```


## Observed vs expected VA (full)

```{r, fig.width=8, fig.height=2}
va.full$fit.plots$p1


t1 <- va.full$fit.plots$p1

t2.va.full<- t1 +
  facet_wrap(~agec, scales='free', nrow=1)+
    theme(legend.position="none")+
  ylab('Deaths/100000')+
  ggtitle('VA enrollees')
t2.va.full

```

```{r, fig.width=8, fig.height=4}
grid.arrange(t2.cdc, t2.va.full)
```


## Observed vs expected VA (active enrollees)

```{r fig.width=8, fig.height=4}
va.users$fit.plots$p1

```

Population size for VA users over time by age

```{r}
ggplot(va.users$preds.age, aes(x=date, y=pop, group=agec, col=agec)) +
  theme_classic() +
  geom_line()

```

Population size by race and age

```{r, fig.width=6, fig.height=4}
ggplot(va.users$preds.age_race, aes(x=date, y=pop, group=agec, col=agec)) +
  theme_classic() +
  geom_line() +
  ylim(0,NA) +
  facet_wrap(~race_recode, scales='free')

```

Observed vs expected (VA users)

```{r, fig.width=8, fig.height=8}
va.users$fit.plots$p3 +ggtitle('White males') #white males
va.users$fit.plots$p5 +ggtitle('All adults') #all people >25 years



```

Observed vs expected (VA full)

```{r, fig.width=8, fig.height=8}
va.full$fit.plots$p5

```

Observed vs expected (CDC)

```{r}
cdc$fit.plots$p5

```


## Changes by quarter in 2020 compared with expected values in the 3 populations 

```{r, fig.width=8, fig.height=4}

va.users$preds.age$source <- 'va.users'

va.full$preds.age$source <- 'va.full'

preds.age <- bind_rows(cdc$preds.age, va.full$preds.age, va.users$preds.age)

 p1 <- RR_plot(ds=preds.age ,datemin='2020-01-01', add.CIs=F) + 
    facet_grid(~agec, scales='fixed')
 
 p1
 
 #average RR across ages; weight by pop
 ave_rr <- preds.age[preds.age$date>='2020-01-01',] %>%
   group_by(source, date) %>%
   summarize(ave_RR= round(sum((RR_median*pop)/sum(pop)),2) )
 ave_rr
```

## Changes by quarter in 2020 compared with expected values in the 3 populations 

By region and age

```{r, fig.width=8, fg.height=12}

va.users$preds.age.race.region$source <- 'va.users'
va.full$preds.age.race.region$source <- 'va.full'

preds.age.race.region <- bind_rows(cdc$preds.age.race.region, va.users$preds.age.race.region,va.full$preds.age.race.region)

 p2 <- RR_plot(ds=preds.age.race.region[preds.age.race.region$race_recode==1 & preds.age.race.region$sex=='M',] ,datemin='2020-01-01',add.CIs=F) + 
    facet_grid(region~agec, scales='fixed')
 
 p2
```
Overall rate ratio (observed/expected) in the CDC, VA full and VA users
```{r}
test.list <- list(cdc, va.full, va.users)

summary1 <- lapply(test.list,extract_func ,measure='RR', round.level=2)

sapply(summary1, '[[','overall.results' , simplify='array')

qtr.age.res <- sapply(summary1, '[[','age.qtr.results' , simplify=F)
qtr.age.res[[3]]
```

Excess deaths/100,000 in the CDC, VA full and VA users
```{r}
sapply(test.list,extract_func ,measure='excess_inc', round.level=-1, simplify='array')
```
Number of excess deaths in CDC, VA full and VA users

```{r}
sapply(test.list,extract_func ,measure='excess', round.level=-2, simplify='array')

```

## Population-standardized excess incidence

```{r}
va.users$std.inc$source <- 'va.users'
va.full$std.inc$source <- 'va.full'

std.inc <- bind_rows(va.users$std.inc, va.full$std.inc, cdc$std.inc)
std.inc$std_excess_inc <- round(std.inc$std_excess_inc, 1)

std.inc.c <- dcast(std.inc, date~source, value.var='std_excess_inc')
std.inc.c
```

## Excess deaths per 100,000 by age group

```{r}

excess.ds <- preds.age %>%
  select(source, agec, date, starts_with('excess_inc')) %>%
  mutate(excess_inc = paste0(round(excess_inc_median, 1) , ', (' ,round(excess_inc_lcl, 1) , ', ', round(excess_inc_ucl, 1) , ')'  )    )

excess.ds.m <- melt(excess.ds[,c('source','agec','date','excess_inc')], id.vars=c('source','agec','date'))
excess.ds.c <- dcast(excess.ds.m, agec+ date ~ source)

htmlTable(excess.ds.c[excess.ds.c$date>='2020-01-01',c('date','cdc','va.full','va.users')],
          n.rgroup=c(4,4,4,4,4), rgroup=unique(excess.ds.c$agec), rnames=F,
          caption='Table 2: Excess Deaths per 100,000 population')
```


## Excess deaths per 100,000 in the Northeast among white males

```{r}

excess.ds.age.region <- preds.age.race.region %>%
  select(source, agec,region,sex,race_recode, date, starts_with('excess_inc')) %>%
  mutate(excess_inc = paste0(round(excess_inc_median, 0) , ', (' ,round(excess_inc_lcl, 0) , ', ', round(excess_inc_ucl, 0) , ')'  )    )

excess.ds.age.region.m <- melt(excess.ds.age.region[,c('source','agec','sex','race_recode','region','date','excess_inc')], id.vars=c('source','agec','date', 'sex', 'region','race_recode'))



excess.ds.age.region.c <- dcast(excess.ds.age.region.m, agec+ sex+region + date +race_recode ~ source)

htmlTable(excess.ds.age.region.c[excess.ds.age.region.c$date>='2020-01-01' & excess.ds.age.region.c$race_recode==1 & excess.ds.age.region.c$sex=='M' & excess.ds.age.region.c$region=='Northeast',c('date','cdc','va.full','va.users')],
          n.rgroup=c(4,4,4,4,4), rgroup=unique(excess.ds.c$agec), rnames=F,
          caption='Table 2: Excess Deaths per 100,000 population in the Northeast, White, males')


```




