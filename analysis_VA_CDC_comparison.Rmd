---
title: "Compare excess death in VA and CDC data"
author: "Dan Weinberger"
date: "3/15/2022"
output:
  html_document:
    df_print: paged
    html_document: null
    toc: yes
    toc_depth: 2
    toc_float: yes
  word_document:
    toc: yes
    toc_depth: '2'
  pdf_document: 
    keep_tex:  true
params:
  agg.level: 'state'
  n.days.filter: 20
  web.version: FALSE
  extrap.date: '2020-01-26'
  count.start.date: '2020-03-01'
  end.data.date: '2020-09-05'
---

```{r setup, include = F}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo=F,
  warning=FALSE, 
  message=FALSE,
  comment = "#>",
  dev=c('png','pdf'),
  fig.path='./figures/',
  gganimate = list(
    nframes = 50)
)

library(readxl)
library(reshape2)
library(ggplot2)
library(lubridate)
library(RColorBrewer)
library(plotly)
library(MMWRweek)
library(readr)
library(zoo)
library(rjson)
library(parallel)
library(htmlTable)
library(RSocrata)
library(pdftools)
library(readr)
library(patchwork)
library(abind)
library(INLA)
library(gsubfn)
library(dplyr)
library(RCurl)
library(dplyr)
library(tidyverse)
library(gridExtra)
library(gifski)
library(gganimate)
library(shiny)
library(INLA)
library(lme4)

library(pbapply)
#library(jsonlite)
set.seed(123)

source('./R/read_dependent_scripts.R')

```

RACE RECODE:
 1=White
 2=Black
 3=Hispanic
 4=American Indian
 5=Asian/Hawaiian/Pacific Islanders

```{r}
cdc<- readRDS('./outputs/summary_list_cdc.rds')

va.full <- readRDS('./outputs/confidential/outputs_all/summary_list_va.rds')

#VA active users using Christopher's definition
va.users.cr <- readRDS('./outputs/confidential/outputs_users_CR_definition/summary_list_va.rds')

#Liam's definition of active user (most stringent inclusion criteria)
va.users.lr <- readRDS('./outputs/confidential/outputs_users_LR_definition/summary_list_va.rds')

```

## Figure S4

```{r, fig.width=5.5, fig.height=5}
race_recode.labs1 <- c('White', 'Black', 'Hispanic', 'American Indian','Asian/Hawaiian/Pac Is.' )

plot.ds <- cdc$preds.age_race %>%
  filter(date>='2020-01-01' & race_recode %in% c('1','2','3')) %>%
  mutate(race_recode=as.numeric(as.character(race_recode)),
         race_recode = factor(race_recode, levels=c(1:5), labels=race_recode.labs1),
         qtr = quarter(date),
         agec = if_else(agec=='85 years and older','85+y', agec),
         year=year(date),
         qdate = as.factor(paste0('Q',qtr))
         ) %>%
  rename(RaceEthnicity=race_recode)

plot1.cdc <-  ggplot(plot.ds,aes(x=qdate, y=RR_std_median, group=RaceEthnicity, color=RaceEthnicity)) +
  geom_line()+
  ylim(0.75,2.0)+
  geom_ribbon(data=plot.ds, aes(x=qdate, ymin=RR_std_lcl, ymax=RR_std_ucl, fill=RaceEthnicity), alpha=0.5) +
    facet_wrap(~agec, nrow=1) +
  theme_classic() +
  geom_hline(yintercept=1, lty=2, col='gray') +
    geom_hline(yintercept=c(1.2,1.4,1.6,1.8), lty=3, col='gray', alpha=0.75) +

  ylab('Risk Ratio')+
  xlab('')

#plot1.cdc

plot.ds.enrollee <- va.full$preds.age_race %>%
  filter(date>='2020-01-01' & race_recode %in% c('1','2','3')) %>%
  mutate(race_recode=as.numeric(as.character(race_recode)),
         race_recode = factor(race_recode, levels=c(1:5), labels=race_recode.labs1),
         qtr = quarter(date),
         agec = if_else(agec=='85 years and older','85+y', agec),
         year=year(date),
         qdate = as.factor(paste0('Q',qtr))
         ) %>%
  rename(RaceEthnicity=race_recode)

plot1.enrollee <-  ggplot(plot.ds.enrollee,aes(x=qdate, y=RR_std_median, group=RaceEthnicity, color=RaceEthnicity)) +
  geom_line()+
  ylim(0.75,2.0)+
  geom_ribbon(data=plot.ds.enrollee, aes(x=qdate, ymin=RR_std_lcl, ymax=RR_std_ucl, fill=RaceEthnicity), alpha=0.5) +
    facet_wrap(~agec, nrow=1) +
  theme_classic() +
  geom_hline(yintercept=1, lty=2, col='gray') +
  ylab('Risk Ratio')+
    geom_hline(yintercept=c(1.2,1.4,1.6,1.8), lty=3, col='gray', alpha=0.75) +

  xlab('')

#plot1.cdc


plot.ds <- va.users.cr$preds.age_race %>%
  filter(date>='2020-01-01' & race_recode %in% c('1','2','3')) %>%
  mutate(race_recode=as.numeric(as.character(race_recode)),
         race_recode = factor(race_recode, levels=c(1:5), labels=race_recode.labs1),
         qtr = quarter(date),
         agec = if_else(agec=='85 years and older','85+y', agec),
         year=year(date),
         qdate = as.factor(paste0('Q',qtr))
         ) %>%
  rename(RaceEthnicity=race_recode)

plot2.va.users <-  ggplot(plot.ds,aes(x=qdate, y=RR_std_median, group=RaceEthnicity, color=RaceEthnicity)) +
  geom_line()+
  ylim(0.75,2.0)+
  geom_ribbon(data=plot.ds, aes(x=qdate, ymin=RR_std_lcl, ymax=RR_std_ucl, fill=RaceEthnicity), alpha=0.5) +
    facet_wrap(~agec, nrow=1) +
  theme_classic() +
  geom_hline(yintercept=1, lty=2, col='gray') +
  geom_hline(yintercept=c(1.2,1.4,1.6,1.8), lty=3, col='gray', alpha=0.75) +
  ylab('Risk Ratio')+
  xlab('')
#plot2.va.users

plot1.cdc/plot1.enrollee/plot2.va.users + plot_annotation(tag_levels = 'A')
```


```{r, fig.width=2.5, fig.height=4}
race_recode.labs1 <- c('White', 'Black', 'Hispanic', 'American Indian','Asian/Hawaiian/Pac Is.' )

plot.ds <- cdc$preds.sex %>%
  filter(date>='2020-01-01') %>%
  mutate(
         qtr = quarter(date),
         year=year(date),
         qdate = as.factor(paste0('Q',qtr))
         )

plot1.cdc <-  ggplot(plot.ds,aes(x=qdate, y=RR_std_median, group=sex, color=sex)) +
  geom_line()+
  ylim(0.75,2.0)+
  geom_ribbon(data=plot.ds, aes(x=qdate, ymin=RR_std_lcl, ymax=RR_std_ucl, fill=sex), alpha=0.5) +
  theme_classic() +
  geom_hline(yintercept=1, lty=2, col='gray') +
  ylab('Risk Ratio')+
    geom_hline(yintercept=c(1.2,1.4,1.6,1.8), lty=3, col='gray', alpha=0.75) +

  xlab('')

#plot1.cdc

plot.ds.enrollee <- va.full$preds.sex %>%
  filter(date>='2020-01-01') %>%
  mutate(
         qtr = quarter(date),
         year=year(date),
         qdate = as.factor(paste0('Q',qtr))
         )

plot2.va.enrollees <-  ggplot(plot.ds.enrollee,aes(x=qdate, y=RR_std_median, group=sex, color=sex)) +
  geom_line()+
  ylim(0.75,2.05)+
  geom_ribbon(data=plot.ds.enrollee, aes(x=qdate, ymin=RR_std_lcl, ymax=RR_std_ucl, fill=sex), alpha=0.5) +
  theme_classic() +
  geom_hline(yintercept=1, lty=2, col='gray') +
  ylab('Risk Ratio')+
    geom_hline(yintercept=c(1.2,1.4,1.6,1.8), lty=3, col='gray', alpha=0.75) +
  xlab('')


plot.ds.users <- va.users.cr$preds.sex %>%
  filter(date>='2020-01-01') %>%
  mutate(
         qtr = quarter(date),
         year=year(date),
         qdate = as.factor(paste0('Q',qtr))
         )

plot2.va.users <-  ggplot(plot.ds.users,aes(x=qdate, y=RR_std_median, group=sex, color=sex)) +
  geom_line()+
  ylim(0.75,2.0)+
  geom_ribbon(data=plot.ds.users, aes(x=qdate, ymin=RR_std_lcl, ymax=RR_std_ucl, fill=sex), alpha=0.5) +
  theme_classic() +
  geom_hline(yintercept=1, lty=2, col='gray') +
  ylab('Risk Ratio')+
    geom_hline(yintercept=c(1.2,1.4,1.6,1.8), lty=3, col='gray', alpha=0.75) +
  xlab('')
#plot2.va.users

plot1.cdc/plot2.va.enrollees/plot2.va.users + plot_annotation(tag_levels = 'A')
```

Number of deaths, CR definition
```{r}
htmlTable(va.users.cr$preds.age.overall %>%
  select(agec,  excess_median) %>%
  mutate(excess_median=round(excess_median)))


summary_deaths <- va.users.cr$preds.age.race.region %>%
  mutate(excess_deaths=excess_inc_median*pop/100000 ) %>%
  filter(date>='2020-04-01') %>%
  group_by(agec, race_recode, region, sex) %>%
  summarize(excess_deaths=round(sum(excess_deaths)))

write.csv(summary_deaths, './outputs/summary_excess_group.csv')
```


NOTE TO SELF: Alternative INLA model is fit to the entire dataset and explicitly estimates quarterly change from baseline. Use call_inla_full_ds.R and inla_model_full_ds1.R


## Observed and expected incidence by age


```{r, fig.width=7, fig.height=5}

 va.users.cr$preds.age.overall$source <- 'va.users.cr'
 va.users.lr$preds.age.overall$source <- 'va.users.lr'

 va.full$preds.age.overall$source <- 'va.full'

all.inc <- bind_rows( va.full$preds.age.overall, va.users.cr$preds.age.overall,va.users.lr$preds.age.overall, cdc$preds.age.overall)

all.inc2 <- bind_rows( va.full$preds.age.overall, va.users.cr$preds.age.overall,va.users.lr$preds.age.overall, cdc$preds.age.overall)

all.inc2$exp_inc <- all.inc2$obs_inc-all.inc2$excess_inc_median

all.inc2.m <- melt(all.inc2[,c('agec','source','exp_inc','obs_inc')], id.vars=c('agec','source'))

all.inc2.m$agec2 <- NA
all.inc2.m$agec2[all.inc2.m$agec=="25-44 years"] <- 1
all.inc2.m$agec2[all.inc2.m$agec=="45-64 years"] <- 2
all.inc2.m$agec2[all.inc2.m$agec=="65-74 years"] <- 3
all.inc2.m$agec2[all.inc2.m$agec=="75-84 years"] <- 4
all.inc2.m$agec2[all.inc2.m$agec=="85 years and older"] <- 5

age.labs1 <- c("25-44 years","45-64 years" ,"65-74 years","75-84 years","85 years and older")
all.inc2.m$agec2[all.inc2.m$variable=='exp_inc'] <- all.inc2.m$agec2[all.inc2.m$variable=='exp_inc'] - 0.1

all.inc2.m$pair1 <- as.numeric(as.factor(paste(all.inc2.m$agec, all.inc2.m$source)))
all.inc2.m$source <- factor(all.inc2.m$source, levels=c('cdc','va.full','va.users.cr','va.users.lr') )

```

Plot
```{r, fig.width=6, fig.height=4}

p1 <- ggplot(all.inc2.m, aes(x=agec2, y=log(value),color=source, shape=variable))+
  geom_point() +
  scale_shape_manual(values=c(1,19))+
  geom_line(aes(group = pair1))+
guides(shape = 'none')+ #To turn off shape legend
  theme_classic()+
  scale_x_continuous( breaks = c(1:5),  label = age.labs1)+
  #theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
 # ggtitle('Observed vs expected Incidence in 2020 (open symbol=expected)')+
  ylab('Log(Incidence)')+
  ylim(0,NA)+
  xlab("")+
   scale_color_manual(labels = c("US", "VA enrollees", "VA active users (CR)","VA active users (LR)"), values=c("#000000", "#E69F00", "#56B4E9", "#009E73"))
p1
```


Excess incidence vs expected incidence
Each color is a different age, each symbol a different group
Crosses are VA users
```{r}
plot(log( all.inc$pred_inc_median),log(all.inc$excess_inc_median), col=as.factor(all.inc$agec), pch=as.numeric(as.factor(all.inc$source)))
```

```{r, fig.width=8, fig.height=8}
#plot(va.users.cr$preds.age_race$excess_inc_median)

ggplot(va.users.cr$preds.age_race, aes(x=date, y=excess_inc_median)) +
  geom_line() +
  geom_hline(yintercept=0)+
  theme_classic()+
  ggtitle('Excess Incidence (cases/100,000) by race and age')+
  facet_grid(agec~race_recode, scales='free')
  

ggplot(va.users.cr$preds.age_race, aes(x=date, y=excess_inc_median*pop)) +
  geom_line() +
  geom_hline(yintercept=0)+
  theme_classic()+
  ggtitle('Excess Cases (N) by race and age')+
  facet_grid(agec~race_recode, scales='free')
  

#plot(va.users.cr$preds.age_race$excess_inc_median)

ggplot(cdc$preds.age_race, aes(x=date, y=pop)) +
  geom_line() +
  theme_classic()+
  facet_wrap(agec~race_recode, scales='free')+
  ggtitle('Population size by age and race')
```



## Observed vs expected CDC 

```{r fig.width=8, fig.height=2}
cdc$fit.plots$p1

t2 <- cdc$fit.plots$p1 +
        geom_line(aes(x=date, y =obs_inc, group=agec), col='#1f78b4') +
        geom_line(aes(x=date, y=pred_inc_median, group=agec), lty=1, col='black') 


t2.cdc <- t2 +
  facet_wrap(~agec, scales='free', nrow=1)+
    theme(legend.position="none")+
  ylab('Deaths/100000')+
    ggtitle('General US population')

t2.cdc
```

CDC population 
```{r}
plot(cdc$preds.age$date, cdc$preds.age$pop)
```


## Observed vs expected VA (full)

```{r, fig.width=8, fig.height=2}
va.full$fit.plots$p1


t1 <- va.full$fit.plots$p1 +
      geom_line(aes(x=date, y =obs_inc, group=agec), col='#1f78b4') +
      geom_line(aes(x=date, y=pred_inc_median, group=agec), lty=1, col='black') 


# range_act <- range(range(results$act), range(results$pred))
# 
# dummy <- data.frame(pred = range_act, value = range_act,
#                     variable = "act", stringsAsFactors=FALSE)

t2.va.full<- t1 +
  facet_wrap(~agec, scales='free', nrow=1)+
    theme(legend.position="none")+
  ylab('Deaths/100000')+
  ggtitle('VA enrollees') +
t2.va.full

```

```{r, fig.width=8, fig.height=4}
q1 <- grid.arrange(t2.cdc, t2.va.full)

```

Set same axes for both
```{r, fig.width=8, fig.height=4}
blank_data <- data.frame(agec = c('25-44 years', '45-64 years', '65-74 years', '75-84 years', '85 years and older'),x=as.Date('2014-01-01'), y= c(75,500,1000,2000, 6000))

t3.cdc <- t2.cdc + geom_blank(data = blank_data, aes(x = x, y = y)) +
  theme(panel.spacing = unit(0.75, "lines"))


t3.va.full <- t2.va.full + geom_blank(data = blank_data, aes(x = x, y = y)) +
  theme(panel.spacing = unit(0.75, "lines"))

q2 <- grid.arrange(t3.cdc, t3.va.full, padding = unit(0.25, "line"))
q2

ggsave('Figure 1.tiff',plot=q2, path = './plots', width = 9, height = 4, device='tiff', dpi=300)

```



## Observed vs expected VA (active enrollees)

```{r fig.width=8, fig.height=4}
va.users.cr$fit.plots$p1

t1 <- va.users.cr$fit.plots$p1 +
        geom_line(aes(x=date, y=pred_inc_median, group=agec), lty=2, col='black') 


t2.va.users<- t1 +
  facet_wrap(~agec, scales='free', nrow=1)+
    theme(legend.position="none")+
  ylab('Deaths/100000')+
  ggtitle('VA active users')
t2.va.users

t3.va.users <- t2.va.users + geom_blank(data = blank_data, aes(x = x, y = y))

grid.arrange(t3.cdc, t3.va.users)
```

```{r, fig.width=8, fig.height=6}
grid.arrange(t3.cdc, t3.va.full,t3.va.users)
```

Population size for VA users over time by age

```{r}
ggplot(va.users.cr$preds.age, aes(x=date, y=pop, group=agec, col=agec)) +
  theme_classic() +
  geom_line()

```

```{r}
va.users.cr$preds.age.overall$N_deaths/sum(va.users.cr$preds.age.overall$N_deaths)
```

Population size by race and age

```{r, fig.width=6, fig.height=4}
ggplot(va.users.cr$preds.age_race, aes(x=date, y=pop, group=agec, col=agec)) +
  theme_classic() +
  geom_line() +
  ylim(0,NA) +
  facet_wrap(~race_recode, scales='free')

```

Observed vs expected (VA users)

```{r, fig.width=8, fig.height=8}
va.users.cr$fit.plots$p3 +ggtitle('White males') #white males
va.users.cr$fit.plots$p5 +ggtitle('All adults') #all people >25 years



```

Observed vs expected (VA full)

```{r, fig.width=8, fig.height=8}
va.full$fit.plots$p5

```

Observed vs expected (CDC)

```{r}
cdc$fit.plots$p5

```


## Changes by quarter in 2020 compared with expected values in the 3 populations 

```{r, fig.width=8, fig.height=4}

va.users.cr$preds.age$source <- 'va.users'

va.full$preds.age$source <- 'va.full'

preds.age <- bind_rows(cdc$preds.age, va.full$preds.age, va.users.cr$preds.age)

 p1 <- RR_plot(ds=preds.age ,datemin='2020-01-01', add.CIs=F) + 
    facet_grid(~agec, scales='fixed')
 
 p1
 
 #average RR across ages; weight by pop
 ave_rr <- preds.age[preds.age$date>='2020-01-01',] %>%
   group_by(source, date) %>%
   summarize(ave_RR= round(sum((RR_median*pop)/sum(pop)),2) )
 ave_rr
```

## Changes by quarter in 2020 compared with expected values in the 3 populations 

By region and age

```{r, fig.width=6, fig.height=4}

va.users.cr$preds.age.race.region$source <- 'va.users'
va.full$preds.age.race.region$source <- 'va.full'

preds.age.race.region <- bind_rows(cdc$preds.age.race.region, va.users.cr$preds.age.race.region,va.full$preds.age.race.region)

 p2 <- RR_plot(ds=preds.age.race.region[preds.age.race.region$race_recode==1 & preds.age.race.region$sex=='M',] ,datemin='2020-01-01',add.CIs=F) + 
    facet_grid(region~agec, scales='fixed') +
     geom_hline(yintercept = 1, lty=2, col='gray')

 
 p2
# ggsave('Fig S1 rr_region_age.jpg',path = './plots', width = 8, height =6, device='jpg', dpi=400)

 
 plot.ds <- preds.age.race.region[preds.age.race.region$race_recode==1 & preds.age.race.region$sex=='M',]
 plot.ds$qdate <- as.yearqtr(plot.ds$date)
 plot.ds$labels <- NA
 plot.ds$labels[plot.ds$source=='cdc'] <- 'US'
 plot.ds$labels[plot.ds$source=='va.full'] <- 'VA enrollees'
 plot.ds$labels[plot.ds$source=='va.users'] <- 'VA active users'
 
 plot.ds <- plot.ds %>%
   mutate(year=year(qdate),
          qtr=quarter(qdate),
          qdate_cat = as.factor(paste0(year, ' Q', qtr)),
          agec = if_else(agec=='85 years and older',' 85+ years',agec)) 
   
 p.rr_region <-ggplot( data=plot.ds, aes(x=qdate_cat , y=RR_std_median, group=labels, col=labels ,linetype=labels)) +
         geom_line(alpha=0.5) +
          geom_point(data=plot.ds ,aes(x=qdate_cat , y=RR_std_median,group=labels, shape=labels))+
         theme_classic() +
  facet_grid(region~agec, scales='free_x') +
  scale_y_continuous(name='Risk ratio') +
  #scale_x_yearqtr(format = '%Y Q%q', n=4) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
     geom_hline(yintercept = 1, lty=2, col='gray') +
   xlab('') +
   ylab('Risk ratio')+ 
   theme(legend.title=element_blank())
 
 ggsave('Fig S1 rr_region_age.jpg',plot=p.rr_region,path = './plots', width = 8, height =6, device='jpg', dpi=400)
 
 p.rr_region

```

Overall risk ratio (observed/expected) in the CDC, VA full and VA users
```{r}
test.list <- list(cdc, va.full, va.users.cr, va.users.lr)

summary1 <- lapply(test.list,extract_func ,measure='RR', round.level=2)

sapply(summary1, '[[','overall.results' , simplify='array')

View(test.list[[1]]$preds.date )
View(test.list[[2]]$preds.date ) #va full
View(test.list[[3]]$preds.date ) #CR def of users
View(test.list[[4]]$preds.date ) #LR definition of useres

qtr.age.res <- sapply(summary1, '[[','age.qtr.results' , simplify=F)
qtr.age.res[[3]]
```

Excess deaths/100,000 in the CDC, VA full and VA users
```{r}
sapply(test.list,extract_func ,measure='excess_inc', round.level=-1, simplify='array')
```

Number of excess deaths in CDC, VA full and VA users

```{r}
#sapply(test.list,extract_func ,measure='excess', round.level=-2, simplify='array')

```

```{r}
sapply(test.list,extract_func ,measure='RR', round.level=2, simplify='array')
```


```{r}
sapply(test.list,extract_func ,measure='excess_inc', round.level=0, simplify='array')
```

```{r}
sapply(test.list,extract_func ,measure='pred_inc', round.level=0, simplify='array')
```

```{r}
c(test.list[[1]]$preds.overall$obs_inc, test.list[[2]]$preds.overall$obs_inc, test.list[[3]]$preds.overall$obs_inc)
```

```{r}
sapply(test.list,extract_func ,measure='expected_std_inc', round.level=0, simplify='array')
```

```{r}
sapply(test.list,extract_func ,measure='RR_std', round.level=2, simplify='array')
```

```{r}
sapply(test.list,extract_func ,measure='excess_std_inc', round.level=0, simplify='array')
```

```{r}
c(test.list[[1]]$preds.overall$obs_std_inc, test.list[[2]]$preds.overall$obs_std_inc, test.list[[3]]$preds.overall$obs_std_inc)
```




extract_func(results, measure= 'RR', round.level = 2 )

extract_func(results, measure= 'RR_std', round.level = 2 )

extract_func(results, measure= 'excess_inc', round.level = 0 )

extract_func(results, measure= 'excess_std_inc', round.level = 0 )



extract_func(results, measure= 'expected_std_inc', round.level = 0 )


extract_func(results, measure= 'expected_std_inc', round.level = 0 )


Pop standardized RR. We will use the VA enrollees as the reference population for standardizing. If we go the other way (standardizing to US pop) things get funky because estimates for the women in the VA are based on only ~3% of ote deaths, but then get inflated to ~1/2 the deaths aftr standardizing.

--RR = Observed Inc/ Expected Inc --need to calculate (sum(Pop_std_observed_inc)/sum(Pop_st_expected_inc))

Calculations to recover observed and expected incidence from RR and excess incidence
observed = excess + expected
RR = obs/expected
RR = (excess+expected)/expected

RR*expected = excess + expected
RR*expected - expected = excess
expected * (RR- 1) = excess
expected = excess/(RR-1)
observed = excess + excess/(RR-1) = excess * (1 + 1/(RR-1))

test1: 12000 obs, 10000 exp; RR=1.2; excess=2000
2000*(1+1/0.2)=12000=observed

test2: 8000 obs, 10000 exp; RR=0.8; excess=-2000
-2000*(1 + 1/(-0.2))=8000=observed

test3: doesn't work if RR=1
10000 obs, 10000 exp; RR=1.0; excess=0
0*(1 + 1/(0)=NaN=observed




```{r}
std.pop.age.region.sex.race <- readRDS('./Data/std.pop.age.region.sex.race.rds')

std.pop.va <- va.full$preds.age.race.region %>%
  group_by(agec, sex, race_recode, region) %>%
  summarize(std.pop.va=mean(pop)) %>% 
  ungroup() %>%
  mutate( tot_pop= sum(std.pop.va),
                       std.pop.va= std.pop.va/tot_pop) %>%
  filter(race_recode !='0')

saveRDS(std.pop.va,'./Data/std.pop.VAenrollees.age.region.sex.race.rds')

va.users.lr$preds.age.race.region$source <- 'va.lr'
va.users.cr$preds.age.race.region$source <- 'va.cr'
  va.full$preds.age.race.region$source <- 'va.full'

a1 <- list(cdc$preds.age.race.region, va.full$preds.age.race.region , va.users.cr$preds.age.race.region )##,
           #va.users.lr$preds.age.race.region)
names(a1) <- c('US','VA enrollees','VA active users' ) # , 'VA active users (frequent)')

a2 <- lapply(names(a1), function(y){
  x <- a1[[y]]
  x$expected_inc = (x$excess_inc_median)/((x$RR_median)-1)
  x$expected_inc[x$RR_median==1] <- 0
x$obs_inc = x$excess_inc_median + x$expected_inc
  x$obsN = x$obs_inc*x$pop/100000
  x$expectedN= x$expected_inc*x$pop/100000
return(x)
})
names(a2) <- c('US','VA enrollees','VA active users') #, 'VA active users (frequent)')

std_rr_func <- function( y , M_only=F){
    
    x <- a2[[y]]
    
    a2 <- merge(x, std.pop.va, by=c('agec','sex','race_recode','region'), all=T)
    
    a2$std.pop.va[is.na(a2$std.pop.va)] <- 0
    
    if(M_only==T){
      a2 <- a2[a2$sex=='M',]
    }
    rr.ave <- a2 %>%
      group_by(date) %>%
      summarize('sum_obs_std'= sum((obsN)*std.pop.va/sum(std.pop.va)/pop), 
                'sum_expected_std'= sum((expectedN)*std.pop.va/sum(std.pop.va)/pop),
                'sum_obs'= sum((obsN)), 
                'sum_expected'= sum((expectedN))
                
                ) %>%
      mutate('Std_RR'=sum_obs_std/sum_expected_std,
             'Raw_RR'=sum_obs/sum_expected)
    rr.ave$label= y
    
    return(rr.ave)
}

std.rrs <- lapply(names(a2), std_rr_func)

all.std.rrs <- bind_rows(std.rrs)

all.std.rrs.plot <- melt(all.std.rrs[,c('date','label', 'Std_RR','Raw_RR')], id.vars=c('date','label'))
```


```{r, fig.width=6, fig.height=3}

all.std.rrs.plot$variable <- factor(all.std.rrs.plot$variable, c('Raw_RR','Std_RR'))

all.std.rrs.plot$qdate <- as.yearqtr(all.std.rrs.plot$date)

all.std.rrs.plot <- all.std.rrs.plot %>%
filter(!is.na(date)) %>%
   mutate(year=year(qdate),
          qtr=quarter(qdate),
          qdate_cat = as.factor(paste0(year, ' Q', qtr)),
          variable = if_else(variable=='Raw_RR', 'a. Unadjusted RR', 'b. Standardized RR')) 

p.rr <- ggplot(all.std.rrs.plot, aes(x=qdate_cat , y=value, group=label, col=label ,linetype=label)) +
         geom_line(alpha=0.5) +
          geom_point(data=all.std.rrs.plot ,aes(x=qdate_cat , y=value,group=label, shape=label))+
         theme_classic() +
  facet_wrap(vars(variable)) +
  scale_y_continuous(name='Risk ratio') +
  ggtitle('Raw and standarized Risk Ratios') +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  xlab('') +
  geom_hline(yintercept = 1, lty=2, col='gray') + 
  theme(legend.title=element_blank())

p.rr
ggsave('Figure 2 rr_plot.tiff',path = './plots', width = 6, height = 3, device='tiff', dpi=400)

```

Compare RR from men and women across different populations
```{r}
 comp.rr1 <- 
  merge(a2[[1]], a2[[2]], by=c('agec','sex','race_recode','region','date'))

ggplot(comp.rr1[comp.rr1$obsN.y>=0 ,], aes(x=log(RR_median.x), y=log(RR_median.y), group=region, col=agec, size=obsN.y))+
  geom_point()+
  geom_abline()+
  theme_classic()+
      scale_size(range = c(.1, 10), name="N deaths")+
  facet_wrap(~sex) 


ggplot(comp.rr1[comp.rr1$obsN.y>=0 ,], aes(x=log(obs_inc.x), y=log(obs_inc.y), group=region, col=agec))+
  geom_point()+
  geom_abline()+
  theme_classic()+
  #ylim(0, 25000)+
  #xlim(0,25000)+
  facet_wrap(~sex) 


```

```{r}
 comp.rr1 <-  bind_rows(a2) 
comp1.rr1.m <- melt(comp.rr1, id.vars=c('source','agec','region','race_recode','sex','date'))
comp1.rr1.c <- dcast( comp1.rr1.m, agec+region+race_recode+sex+date ~ source+ variable, value.var = 'value' )
comp1.rr1.c$sex <- factor(comp1.rr1.c$sex, c('M','F'))
comp1.rr1.c$region <- factor(comp1.rr1.c$region)
comp1.rr1.c$agec <- factor(comp1.rr1.c$agec)
```

Relative increases in the VA and US populations
```{r}

ggplot(comp1.rr1.c[!is.na(comp1.rr1.c$va.full_RR_median ),], aes(x=log(cdc_RR_median), y=log(va.full_RR_median), group=region, col=agec, size=va.full_pop))+
  geom_point(alpha=0.3)+
  geom_abline()+
  theme_classic()+
      scale_size(range = c(.1, 10), name="N deaths")+
  facet_wrap(~sex)
```

```{r}

ggplot(comp1.rr1.c, aes(x=log(cdc_obs_inc), y=log(va.full_obs_inc), group=region, col=agec, size=va.full_pop))+
  geom_point(alpha=0.5)+
  geom_abline()+
  theme_classic() +
        scale_size(range = c(.1, 8), name="Population size")+
  facet_wrap(~sex) +
  ylab('Log(Deaths/100,000 among VA enrollees)') +
  xlab('Log(Deaths/100,000 among the US population)')


```

Did women in the VA fare worse in terms of excess deaths than the general population? By eye it seems so
```{r}
ggplot(comp1.rr1.c, aes(x=log(cdc_excess_inc_median), y=log(va.full_excess_inc_median), group=region, col=agec, size=va.full_pop))+
  geom_point(alpha=0.5)+
  geom_abline()+
  theme_classic() +
        scale_size(range = c(.1, 8), name="Population size")+
  facet_wrap(~sex) +
  ylab('Log(Deaths/100,000 among VA enrollees)') +
  xlab('Log(Deaths/100,000 among the US population)')




```

Did race/ethnic groups in the VA fare worse in terms of excess deaths than the general population? 
```{r}
ggplot(comp1.rr1.c, aes(x=log(cdc_excess_inc_median), y=log(va.full_excess_inc_median), group=region, col=agec, size=va.full_pop))+
  geom_point(alpha=0.5)+
  geom_abline()+
  theme_classic() +
        scale_size(range = c(.1, 8), name="Population size")+
  facet_wrap(~race_recode) +
  ylab('Log(Deaths/100,000 among VA enrollees)') +
  xlab('Log(Deaths/100,000 among the US population)')




```
 How about by agec
```{r}
ggplot(comp1.rr1.c, aes(x=log(cdc_excess_inc_median), y=log(va.full_excess_inc_median), group=region, col=sex, size=va.full_pop))+
  geom_point(alpha=0.5)+
  geom_abline()+
  theme_classic() +
        scale_size(range = c(.1, 8), name="Population size")+
  facet_wrap(~agec) +
  ylab('Log(Deaths/100,000 among VA enrollees)') +
  xlab('Log(Deaths/100,000 among the US population)')


```




Plot observed vs expected using standardized incidence--using the observed data, this should give plot same as above
```{r, fig.width=6, fig.height=3}
b1 <- bind_rows(a2)
b1 <- merge(b1, std.pop.va, by=c('agec','race_recode','sex','region'), all=T)

b1$std.pop.va[is.na(b1$std.pop.va)] <- 0

b2 <- b1[b1$date>='2020-04-01',] %>%
  group_by(source, agec) %>%
  summarize(sum.obsN= sum(obsN), 
            n_times=length(unique(date)),
            obs.std.N = 100000*sum( (obsN * std.pop.va/pop)/sum(std.pop.va) ) ,
            exp.std.N = 100000*sum( (expectedN * std.pop.va/pop)/sum(std.pop.va) ),
            expN=sum(expectedN), 
            pop=sum(pop)/n_times ) %>% #divide pop by 4 bc 4 time point per group
  ungroup() %>%
  mutate('obs_inc'=sum.obsN/pop*100000, 'exp_inc'=expN/pop*100000, 'ratio'=obs_inc/obs.std.N)

ggplot(b2[b2$source=='va.full',], aes(x=obs_inc, y=obs.std.N, col=source)) + 
  geom_point() + 
  theme_classic() +
  geom_abline()
       
b2.m <- melt(b2[,c('agec', 'source', 'obs_inc','exp_inc')], id.vars=c('agec', 'source'))

b2.m$source <- factor(b2.m$source, c('cdc','va.full','va.users') )#,'va.lr'))

b2.m$agec2 <- NA
b2.m$agec2[b2.m$agec=="25-44 years"] <- 1
b2.m$agec2[b2.m$agec=="45-64 years"] <- 2
b2.m$agec2[b2.m$agec=="65-74 years"] <- 3
b2.m$agec2[b2.m$agec=="75-84 years"] <- 4
b2.m$agec2[b2.m$agec=="85 years and older"] <- 5

age.labs1 <- c("25-44 years","45-64 years" ,"65-74 years","75-84 years","85 years and older")
b2.m$agec2[b2.m$variable=='exp_inc'] <- b2.m$agec2[b2.m$variable=='exp_inc'] - 0.1

b2.m$pair1 <- as.numeric(as.factor(paste(b2.m$agec, b2.m$source)))

p1 <- ggplot(b2.m, aes(x=agec2, y=log(value),color=source, shape=variable))+
  geom_point() +
  scale_shape_manual(values=c(1,19))+
  geom_line(aes(group = pair1))+
guides(shape = 'none')+ #To turn off shape legend
  theme_classic()+
  scale_x_continuous( breaks = c(1:5),  label = age.labs1)+
  #theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
 # ggtitle('Observed vs expected Incidence in 2020 (open symbol=expected)')+
  ylab('Log(Incidence)')+
  ylim(0,NA)+
  xlab("")+
   scale_color_manual(labels = c("US", "VA enrollees", "VA active users (CR)","VA active users (LR)"), values=c("#000000", "#E69F00", "#56B4E9", "#009E73"))+
  ggtitle('Observed and expected incidence')
p1

###REPEAT USING THE STANDARDIZED  POPs

c2.m <- melt(b2[,c('agec', 'source', 'obs.std.N','exp.std.N')], id.vars=c('agec', 'source'))
c2.m$source <- factor(c2.m$source, c('cdc','va.full','va.users','va.lr'))

c2.m$agec2 <- NA
c2.m$agec2[c2.m$agec=="25-44 years"] <- 1
c2.m$agec2[c2.m$agec=="45-64 years"] <- 2
c2.m$agec2[c2.m$agec=="65-74 years"] <- 3
c2.m$agec2[c2.m$agec=="75-84 years"] <- 4
c2.m$agec2[c2.m$agec=="85 years and older"] <- 5

age.labs1 <- c("25-44 years","45-64 years" ,"65-74 years","75-84 years","85 years and older")
c2.m$agec2[c2.m$variable=='exp.std.N'] <- c2.m$agec2[c2.m$variable=='exp.std.N'] - 0.1

c2.m$pair1 <- as.numeric(as.factor(paste(c2.m$agec, c2.m$source)))


p2 <- ggplot(c2.m, aes(x=agec2, y=log(value),color=source, shape=variable))+
  geom_point() +
  scale_shape_manual(values=c(1,19))+
  geom_line(aes(group = pair1))+
guides(shape = 'none')+ #To turn off shape legend
  theme_classic()+
  scale_x_continuous( breaks = c(1:5),  label = age.labs1)+
  #theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
 # ggtitle('Observed vs expected Incidence in 2020 (open symbol=expected)')+
  ylab('Log(Incidence)')+
  ylim(0,NA)+
  xlab("")+
   scale_color_manual(labels = c("US", "VA enrollees", "VA active users (CR)","VA active users (LR)"), values=c("#000000", "#E69F00", "#56B4E9", "#009E73"))+
  ggtitle('Observed and expected incidence, standardized population')

p2
ggsave('obs_expected_age.jpg',path = './plots', width = 6, height = 4, device='jpeg', dpi=400)

```

```{r, fig.width=6, fig.height=4}

p1 
p2
```


## Summary observed an standardized deaths rates for Table 2

```{r}
c2 <- b1[b1$date>='2020-04-01',] %>%
  group_by(source) %>%
  summarize(sum.obsN= sum(obsN), 
            n.times=length(unique(date)),
            obs.std.N = 100000*sum( (obsN * std.pop.va/pop)/sum(std.pop.va) )*n.times ,
            exp.std.N = 100000*sum( (expectedN * std.pop.va/pop)/sum(std.pop.va) )*n.times,
            expN=sum(expectedN), 
            popsum=sum(pop)/n.times ) %>% 
  ungroup() %>%
  mutate('obs_inc'=sum.obsN/popsum*100000, 'exp_inc'=expN/popsum*100000, 'excess_inc'=obs_inc-exp_inc, 'excess_inc_std'=obs.std.N - exp.std.N , 'IRR.raw'=obs_inc/exp_inc)
#remember this is for adults age 25+ only!--103 million people 0-24 years, so that makes sense for 226 million in 25+
c2


```

check work here with data from the Monte Carlo resampled approach
```{r}
round(c(cdc$preds.overall$RR_median, cdc$preds.overall$RR_lcl, cdc$preds.overall$RR_ucl),2)
round(c(va.full$preds.overall$RR_median, va.full$preds.overall$RR_lcl, va.full$preds.overall$RR_ucl),2)

round(c(va.users.cr$preds.overall$RR_median, va.users.cr$preds.overall$RR_lcl, va.users.cr$preds.overall$RR_ucl),2)

```


##Summary by sex
```{r}
cdc$preds.sex %>%
  filter(date>='2020-01-01')

va.users.cr$preds.sex %>%
  filter(date>='2020-01-01')

va.full$preds.sex %>%
  filter(date>='2020-01-01')


plot.ds1 <- cdc$preds.sex %>%
  mutate(expected_inc = obs_std_inc/RR_std_median)

plot.ds2 <- va.full$preds.sex %>%
  mutate(expected_inc = obs_std_inc/RR_std_median)

plot.ds3 <- va.users.cr$preds.sex %>%
  mutate(expected_inc = obs_std_inc/RR_std_median)

ggplot(plot.ds3, aes(x=date, y=log(obs_std_inc), group=sex, col=sex)) +
  geom_line() +
  theme_classic() +
  geom_line(data=plot.ds3,aes(x=date, y=log(expected_inc), group=sex), color='gray') +
  facet_wrap(~sex) +
  ylim(0.5, NA)
```

```{r}
ggplot(cdc$preds.age.sex.overall, aes(x=agec, y=RR_std_median, group=sex, col=sex)) +
         geom_point() +
  geom_point(data=va.users.cr$preds.age.sex.overall, aes(x=agec, y=RR_std_median, group=sex, col=sex), shape=1) + 
  theme_classic()
```


## Figure 3
Observed vs expected by age  
```{r, fig.width=5, fig.height=3.5}

b1.age <- b1

b1.age$std.pop.va[is.na(b1.age$std.pop.va)] <- 0


#should use the age/rac//region distribution from the VA for a particular age gorup and sex as the reference for all the others..this will allow proper comparison across age groups

b1.age.std.pop <- b1.age %>%
  filter( agec=='65-74 years' & source=='va.full' & date=='2020-01-01') %>%
  select(sex, race_recode, region, std.pop.va) %>%
  rename(std.pop.va.age=std.pop.va)

b2.age <- merge(b1.age, b1.age.std.pop, by=c('sex','race_recode','region'))

b2.age <- b2.age[b2.age$date>='2020-04-01',] %>%
  group_by(source, agec) %>%
  summarize(sum.obsN= sum(obsN), 
            n_times=length(unique(date)),
            obs.std.N = 100000*sum( (obsN * std.pop.va.age/pop)/sum(std.pop.va.age) ) ,
            exp.std.N = 100000*sum( (expectedN * std.pop.va.age/pop)/sum(std.pop.va.age) ),
            expN=sum(expectedN), 
            pop=sum(pop)/n_times ) %>% #divide pop by 4 bc 4 time point per group
  ungroup() %>%
  mutate('obs_inc'=sum.obsN/pop*100000, 'exp_inc'=expN/pop*100000, 'ratio'=obs_inc/obs.std.N)


c2.m.age <- melt(b2.age[,c('agec', 'source', 'obs.std.N','exp.std.N')], id.vars=c('agec', 'source'))
c2.m.age$source <- factor(c2.m.age$source, c('cdc','va.full','va.users','va.lr'))

c2.m.age$agec2 <- NA
c2.m.age$agec2[c2.m.age$agec=="25-44 years"] <- 1
c2.m.age$agec2[c2.m.age$agec=="45-64 years"] <- 2
c2.m.age$agec2[c2.m.age$agec=="65-74 years"] <- 3
c2.m.age$agec2[c2.m.age$agec=="75-84 years"] <- 4
c2.m.age$agec2[c2.m.age$agec=="85 years and older"] <- 5

age.labs1 <- c("25-44 years","45-64 years" ,"65-74 years","75-84 years","85 years and older")


c2.m.age$agec2[c2.m.age$variable=='exp.std.N'] <- c2.m.age$agec2[c2.m.age$variable=='obs.std.N'] - 0.2

c2.m.age$pair1 <- as.numeric(as.factor(paste(c2.m.age$agec, c2.m.age$source)))
c2.m.age$agec <- as.factor(c2.m.age$agec)

#Some of the CDC
p2 <- ggplot(c2.m.age, aes(x=agec2, y=log(value),color=source, shape=variable, group=agec))+
  geom_point(alpha=0.5) +
  scale_shape_manual(values=c(1,19))+
  geom_line(aes(group = pair1))+
guides(shape = 'none')+ #To turn off shape legend
  theme_classic()+
  scale_x_continuous( breaks = c(1:5),  label = age.labs1)+

  ylab('Log(Incidence)')+
 # ylim(0,NA)+
  xlab("")+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=1))+
   scale_color_manual(labels = c("US", "VA enrollees", "VA active users","VA active users (LR)"), values=c("#000000", "#E69F00", "#56B4E9", "#009E73"))+
  ggtitle('Observed and expected incidence, standardized population') +
 theme(panel.spacing.x = unit(2, "lines"),panel.spacing.y= unit(4, "lines"))
p2
ggsave('Figure 3 obs_exp_age.tiff',plot=p2,path = './plots', width = 8, height = 4.2, device='tiff', dpi=300)

```

## Figure S2

Observed vs expected by age and sex 
```{r, fig.width=6.5, fig.height=3.5}

b1.sex <- b1

b1.sex$std.pop.va[is.na(b1.sex$std.pop.va)] <- 0


#should use the age/rac//region distribution from the VA for a particular age gorup and sex as the reference for all the others..this will allow proper comparison across age groups

b1.sex.std.pop <- b1.sex %>%
  filter(sex=='M' & agec=='65-74 years' & source=='va.full' & date=='2020-01-01') %>%
  select(race_recode, region, std.pop.va) %>%
  rename(std.pop.va.sex.age=std.pop.va)

b2.sex <- merge(b1.sex, b1.sex.std.pop, by=c('race_recode','region'))

b2.sex <- b2.sex[b2.sex$date>='2020-04-01',] %>%
  group_by(source, agec,sex) %>%
  summarize(sum.obsN= sum(obsN), 
            n_times=length(unique(date)),
            obs.std.N = 100000*sum( (obsN * std.pop.va.sex.age/pop)/sum(std.pop.va.sex.age) ) ,
            exp.std.N = 100000*sum( (expectedN * std.pop.va.sex.age/pop)/sum(std.pop.va.sex.age) ),
            expN=sum(expectedN), 
            pop=sum(pop)/n_times ) %>% #divide pop by 4 bc 4 time point per group
  ungroup() %>%
  mutate('obs_inc'=sum.obsN/pop*100000, 'exp_inc'=expN/pop*100000, 'ratio'=obs_inc/obs.std.N)


c2.m.sex <- melt(b2.sex[,c('agec','sex', 'source', 'obs.std.N','exp.std.N')], id.vars=c('agec','sex', 'source'))
c2.m.sex$source <- factor(c2.m.sex$source, c('cdc','va.full','va.users','va.lr'))

c2.m.sex$agec2 <- NA
c2.m.sex$agec2[c2.m.sex$agec=="25-44 years"] <- 1
c2.m.sex$agec2[c2.m.sex$agec=="45-64 years"] <- 2
c2.m.sex$agec2[c2.m.sex$agec=="65-74 years"] <- 3
c2.m.sex$agec2[c2.m.sex$agec=="75-84 years"] <- 4
c2.m.sex$agec2[c2.m.sex$agec=="85 years and older"] <- 5

c2.m.sex$agec[c2.m.sex$agec=="85 years and older"] <- "85+ years"
age.labs1 <- c("25-44 years","45-64 years" ,"65-74 years","75-84 years","85+ years")

c2.m.sex$sex2 <- 1
c2.m.sex$sex2[c2.m.sex$sex=='F'] <- 2
c2.m.sex$sex2[c2.m.sex$variable=='exp.std.N'] <- c2.m.sex$sex2[c2.m.sex$variable=='exp.std.N'] - 0.2

c2.m.sex$agec2[c2.m.sex$variable=='exp.std.N'] <- c2.m.sex$agec2[c2.m.sex$variable=='exp.std.N'] - 0.2

c2.m.sex$pair1 <- as.numeric(as.factor(paste(c2.m.sex$sex, c2.m.sex$source)))
c2.m.sex$agec <- as.factor(c2.m.sex$agec)
sex.labs1 <- c('M', 'F')


#Some of the CDC
p2 <- ggplot(c2.m.sex, aes(x=sex2, y=log(value),color=source, shape=variable, group=sex2))+
  geom_point() +
  scale_shape_manual(values=c(1,19))+
  geom_line(aes(group = pair1))+
guides(shape = 'none')+ #To turn off shape legend
  theme_classic()+
  scale_x_continuous( breaks = c(1:2),  label = sex.labs1)+

  ylab('Log(Incidence)')+
  ylim(0,NA)+
  xlab("")+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))+
   scale_color_manual(labels = c("US", "VA enrollees", "VA active users (CR)","VA active users (LR)"), values=c("#000000", "#E69F00", "#56B4E9", "#009E73"))+
  ggtitle('Observed and expected incidence, stratified by sex, standardized population') +
  facet_wrap(~agec, ncol=5)+
 theme(panel.spacing.x = unit(2, "lines"),panel.spacing.y= unit(4, "lines"))
p2
ggsave('obs_exp_sex.jpg',path = './plots', width = 8, height = 4, device='jpg', dpi=400)

```

## Figure S3
Observed vs expected by age and race/ethnicity 
 1=White
 2=Black
 3=Hispanic
 4=American Indian
 5=Asian/Hawaiian/Pacific Islanders
```{r, fig.width=5, fig.height=4}

b1.race_recode <- b1

b1.race_recode$std.pop.va[is.na(b1.race_recode$std.pop.va)] <- 0

#should use the age/sex/region distribution from the VA for a particular race/ethnic as the reference for all the others..this will allow proper comparison across age groups

b2.race_recode.std.pop <- b1.race_recode %>%
  filter(race_recode=='1' & source=='va.full' & date=='2020-01-01') %>%
  select(agec,sex, region, std.pop.va) %>%
  rename(std.pop.va.race=std.pop.va)

b2.race_recode <- merge(b1.race_recode, b2.race_recode.std.pop, by=c('agec','sex','region'))

b2.race_recode <- b2.race_recode[b2.race_recode$date>='2020-04-01',] %>%
  group_by(source, race_recode) %>%
  summarize(sum.obsN= sum(obsN), 
            n_times=length(unique(date)),
            obs.std.N = 100000*sum( (obsN * std.pop.va.race/pop)/sum(std.pop.va.race) ) ,
            exp.std.N = 100000*sum( (expectedN * std.pop.va.race/pop)/sum(std.pop.va.race) ),
            expN=sum(expectedN), 
            pop=sum(pop)/n_times ) %>% #divide pop by 4 bc 4 time point per group
  ungroup() %>%
  mutate('obs_inc'=sum.obsN/pop*100000, 'exp_inc'=expN/pop*100000, 'ratio'=obs.std.N/exp.std.N)


c2.m.race_recode <- melt(b2.race_recode[,c('race_recode', 'source', 'obs.std.N','exp.std.N')], id.vars=c('race_recode', 'source'))
c2.m.race_recode$source <- factor(c2.m.race_recode$source, c('cdc','va.full','va.users','va.lr'))


c2.m.race_recode$race_recode2 <- as.numeric(c2.m.race_recode$race_recode)
c2.m.race_recode$race_recode2[c2.m.race_recode$variable=='exp.std.N'] <- c2.m.race_recode$race_recode2[c2.m.race_recode$variable=='exp.std.N'] - 0.2

c2.m.race_recode$agec2[c2.m.race_recode$variable=='exp.std.N'] <- c2.m.race_recode$agec2[c2.m.race_recode$variable=='exp.std.N'] - 0.2

c2.m.race_recode$pair1 <- as.numeric(as.factor(paste(c2.m.race_recode$race_recode, c2.m.race_recode$source)))
race_recode.labs1 <- c('White', 'Black', 'Hispanic', 'American Indian','Asian/Hawaiian/Pac Is.' )

c2.m.race_recode <- c2.m.race_recode %>%
  filter(race_recode !='0')


#Some of the CDC
p2 <- ggplot(c2.m.race_recode, aes(x=race_recode2, y=log(value),color=source, shape=variable, group=race_recode2))+
  geom_point() +
  scale_shape_manual(values=c(1,19))+
  geom_line(aes(group = pair1))+
  guides(shape = 'none')+ #To turn off shape legend
  theme_classic()+
  scale_x_continuous( breaks = c(1:5),  label = race_recode.labs1)+
  ylab('Log(Incidence)')+
  ylim(0,NA)+
  xlab("")+
  theme(axis.text.x = element_text(angle = 20, vjust = 1, hjust=1))+
  scale_color_manual(labels = c("US", "VA enrollees", "VA active users","VA active users (LR)"), values=c("#000000", "#E69F00", "#56B4E9", "#009E73"))+
  ggtitle('Observed and expected incidence, stratified by Race/Ethnicity, standardized pop.') 
p2
ggsave('obs_exp_race.jpg',path = './plots', width = 8, height = 5, device='jpg', dpi=400)


```




## Excess deaths per 100,000 by age group

```{r}

excess.ds <- preds.age %>%
  select(source, agec, date, starts_with('excess_inc')) %>%
  mutate(excess_inc = paste0(round(excess_inc_median, 1) , ', (' ,round(excess_inc_lcl, 1) , ', ', round(excess_inc_ucl, 1) , ')'  )    )

excess.ds.m <- melt(excess.ds[,c('source','agec','date','excess_inc')], id.vars=c('source','agec','date'))
excess.ds.c <- dcast(excess.ds.m, agec+ date ~ source)

htmlTable(excess.ds.c[excess.ds.c$date>='2020-01-01',c('date','cdc','va.full','va.users')],
          n.rgroup=c(4,4,4,4,4), rgroup=unique(excess.ds.c$agec), rnames=F,
          caption='Table 2: Excess Deaths per 100,000 population')
```


## Excess deaths per 100,000 in the Northeast among white males

```{r}

excess.ds.age.region <- preds.age.race.region %>%
  select(source, agec,region,sex,race_recode, date, starts_with('excess_inc')) %>%
  mutate(excess_inc = paste0(round(excess_inc_median, 0) , ', (' ,round(excess_inc_lcl, 0) , ', ', round(excess_inc_ucl, 0) , ')'  )    )

excess.ds.age.region.m <- melt(excess.ds.age.region[,c('source','agec','sex','race_recode','region','date','excess_inc')], id.vars=c('source','agec','date', 'sex', 'region','race_recode'))



excess.ds.age.region.c <- dcast(excess.ds.age.region.m, agec+ sex+region + date +race_recode ~ source)

htmlTable(excess.ds.age.region.c[excess.ds.age.region.c$date>='2020-01-01' & excess.ds.age.region.c$race_recode==1 & excess.ds.age.region.c$sex=='M' & excess.ds.age.region.c$region=='Northeast',c('date','cdc','va.full','va.users')],
          n.rgroup=c(4,4,4,4,4), rgroup=unique(excess.ds.c$agec), rnames=F,
          caption='Table 2: Excess Deaths per 100,000 population in the Northeast, White, males')


```




