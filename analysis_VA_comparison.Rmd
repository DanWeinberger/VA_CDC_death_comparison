---
title: "Excess death in the US by age"
author: "Dan Weinberger"
date: "10/29/2020"
output:
  html_document:
    df_print: paged
    html_document: null
    toc: yes
    toc_depth: 2
    toc_float: yes
  word_document:
    toc: yes
    toc_depth: '2'
  pdf_document: 
    keep_tex:  true
params:
  agg.level: 'state'
  n.days.filter: 20
  web.version: FALSE
  extrap.date: '2020-01-26'
  count.start.date: '2020-03-01'
  end.data.date: '2020-09-05'
---

```{r, include = F}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo=F,
  warning=FALSE, 
  message=FALSE,
  comment = "#>",
  dev=c('png','pdf'),
  fig.path='./figures/',
  gganimate = list(
    nframes = 50)
)

```

```{r setup}
library(readxl)
library(cdcfluview)
library(reshape2)
library(ggplot2)
library(lubridate)
library(RColorBrewer)
library(plotly)
library(MMWRweek)
library(readr)
library(rjson)
library(parallel)
library(htmlTable)
library(RSocrata)
library(pdftools)
library(readr)
library(patchwork)
library(abind)
library(INLA)
library(gsubfn)
library(dplyr)
library(RCurl)
library(dplyr)
library(tidyverse)
library(gifski)
library(gganimate)
library(shiny)
library(INLA)
library(lme4)
library(pbapply)
#library(jsonlite)
set.seed(123)

source('./R/read_dependent_scripts.R')

std.pop.age.region.sex.race <- readRDS('./Data/std.pop.age.region.sex.race.rds')
std.pop.age.sex.race <- readRDS('./Data/std.pop.age.sex.race.rds')
```

Popsize for the CDC data
```{r}
filled_pop2 <- census_popsize_format()

```

Setup CDC data and merge with popsize
```{r}
ag3 <- cdc_data_setup_multilevel()
ag3$log_pop <- log(ag3$pop.interpol/100000)

#Standard population for all strata
# std.pop.age.region.sex.race <- ag3[ag3$date=='2019-10-01' & ag3$source=='cdc', c('agec','region','sex','race_recode','pop.interpol')]
#names(std.pop.age.region.sex.race) <- c('agec','region','sex','race_recode','std.pop')
# 
# 
# std.pop.age.sex.race <- ag3[ag3$date=='2019-10-01' & ag3$source=='cdc' & ag3$region=='Northeast', c('agec','sex','race_recode','pop.interpol')]
#names(std.pop.age.sex.race) <- c('agec','sex','race_recode', 'std.pop')
# 
# saveRDS(std.pop.age.region.sex.race,'./Data/std.pop.age.region.sex.race.rds')
# saveRDS(std.pop.age.sex.race,'./Data/std.pop.age.sex.race.rds')


  summary.cdc <- ag3[ag3$year<2020,] %>%
    group_by(agec, race_recode, region) %>%
    summarize(N_deaths=sum(N_deaths),pop=mean(pop.interpol, na.rm=T)) %>%
    mutate(inc_cdc=N_deaths/pop*100000) %>%
    select(agec, race_recode, region, inc_cdc)
  saveRDS(summary.cdc,'./Data/grp_inc_cdc.R')

```

Read in VA data

```{r}
v1 <- read_csv('./Data/Confidential/aggdata_withregion.csv')
v1$race_recode[is.na(v1$race_recode)] <- 999
v1$pop <- v1$n #pop is specific to the agec, region, sex, year but does NOT vary by race or quarter

v1$N_deaths[v1$N_deaths=='<10'] <- 5 #just as a placeholder...can either have liam run the analysis locally to avoid masking, or figure out an imputation method
v1$N_deaths <- as.numeric(v1$N_deaths)

  v1$month <- NA
  v1$month[v1$qtr==1] <- 1
  v1$month[v1$qtr==2] <- 4
  v1$month[v1$qtr==3] <- 7
  v1$month[v1$qtr==4] <- 10
  v1$date <- as.Date(paste(v1$year, v1$month, '01', sep='-'))

  v1 <- v1[v1$date<=as.Date('2021-01-01'),]
  
  v1 <- v1[!is.na(v1$region) & !is.na(v1$sex) & !is.na(v1$agec),] # for now, ignore deaths where sex, or region or age is NA
  
  summary.va <- v1[v1$year<2020,] %>%
    group_by(agec, race_recode, region) %>%
    summarize(N_deaths=sum(N_deaths),pop=mean(n)) %>%
    mutate(inc_va=N_deaths/pop*100000) %>%
    select(agec, race_recode, region, inc_va)



  v1$source <- 'va'
  
  v1$time <- round(as.numeric(v1$date - min(v1$date))/30.3)
  v1$time_scale <- as.vector(scale(v1$time)) 

  
   v1$qtr2 <- 0
  v1$qtr2[v1$qtr==2] <- 1
  v1$qtr3 <- 0
  v1$qtr3[v1$qtr==3] <- 1
  v1$qtr4 <- 0
  v1$qtr4[v1$qtr==4] <- 1
  
    v1$subgroup_combo <- as.factor(paste(v1$race_recode, v1$agec, v1$sex,v1$region))

      v1$all_cause_pre <- v1$N_deaths
  v1$all_cause_pre[v1$date >= '2020-01-01'] <- NA #bc it is quarterly data, Q1 includes pandeic period
  v1$race_recode <- as.factor(v1$race_recode)
  
  v1 <- v1[v1$agec !="Under 25 Years",]

    v1$inc <- v1$N_deaths/v1$pop*100000
    v1$log_pop <- log(v1$pop/100000)
    
    v1 <- v1[v1$year <=2020,]
```

## Compare baseline rates for VA and cdc by group
```{r}
comp_inc <- merge(summary.cdc,summary.va, by=c('agec', 'race_recode' ,'region'))


p0 <- ggplot(comp_inc,aes(x=inc_cdc, y=inc_va)) +
  geom_point() +
  theme_classic() +
      facet_wrap(~race_recode,  nrow=1) +
  geom_abline(slope=1, intercept=0)

p0

```



https://www.census.gov/programs-surveys/popest/technical-documentation/research/evaluation-estimates/2020-evaluation-estimates/2010s-state-detail.html
Race:
1 = White Alone
2 = Black or African American Alone
3 = American Indian or Alaska Native Alone
4 = Asian Alone
5 = Native Hawaiian and Other Pacific Islander Alone
6 = Two or more races

Sex: 
0 = Total
1 = Male
2 = Female

The key for ORIGIN is as follows:
0 = Total
1 = Not Hispanic
2 = Hispanic

 01 ... Under 1 year (includes not stated infant ages)
 02 ... 1 - 4 years
 03 ... 5 - 14 years
 04 ... 15 - 24 years
 05 ... 25 - 34 years
 06 ... 35 - 44 years
 07 ... 45 - 54 years
 08 ... 55 - 64 years
 09 ... 65 - 74 years
 10 ... 75 - 84 years
 11 ... 85 years and over
 12 ... Age not stated



## Model


Fit to VA and CDC data separately
```{r}

combine.data <- list('cdc'=ag3, 'va'=v1)

mod1 <- pblapply(combine.data, inla_model2)


res1 <- bind_rows(mod1$cdc$preds_covars.m, mod1$va$preds_covars.m) #add VA data too

res1$year <- year(res1$date)
```

We can then take the results from the INLA and aggregate over different groups. For example, by age, by age/race, by age/region, by age/race/region:
```{r}
preds.age <- res1 %>%
  group_by(source,agec, date, variable) %>%
  summarize_grps_sums %>%
  ungroup() %>%
  group_by(source,agec, date) %>%
  summarize_grps_quantiles

preds.age_race <- res1 %>%
  group_by(source,agec, race_recode, date, variable) %>%
  summarize_grps_sums %>%
  ungroup() %>%
  group_by(source,agec,race_recode, date) %>%
  summarize_grps_quantiles

preds.age.region <- res1 %>%
  group_by(source,agec,region, date, variable) %>%
  summarize_grps_sums %>%
  ungroup() %>%
  group_by(source,agec,region, date) %>%
  summarize_grps_quantiles

preds.age.race.region <- res1 %>%
  group_by(source,agec,region,race_recode, date, variable) %>%
  summarize_grps_sums %>%
  ungroup() %>%
  group_by(source,agec,region,race_recode, date) %>%
  summarize_grps_quantiles

```

Population-standardized rates and RRs
```{r}

preds.age.race.region <- res1[res1$year==2020,] %>%
  group_by(source,agec,region,race_recode,sex, date, variable) %>%
  summarize_grps_sums %>%
  ungroup() %>%
  group_by(source,agec,region,race_recode,sex, date) %>%
  summarize_grps_quantiles


##FOR NOW< IGNORE MISSING RACE CATEGORY WHEN CALCULATING STD RATES

std.pop.age.region.sex.race <- std.pop.age.region.sex.race[std.pop.age.region.sex.race$agec!='Under 25 Years',]
std.pop.age.region.sex.race$pop.prop <-
  std.pop.age.region.sex.race$std.pop/sum(std.pop.age.region.sex.race$std.pop)

preds.age.race.region <- merge(preds.age.race.region, std.pop.age.region.sex.race, by=c('agec','region','race_recode','sex'))


std.inc <- preds.age.race.region[preds.age.race.region$race_recode != '999',] %>%
  group_by(source,date) %>%
  summarize(std_excess_inc=sum(excess_inc_median*pop.prop)) %>%
  ungroup()


```

```{r, fig.width=8, fig.height=6}
p1 <- obs_exp_plot(ds=preds.age[preds.age$source=='va',], xvar='date',yvar='N_deaths', groupvar='agec', colvar='agec')
p1 + facet_wrap(~agec, scales='free')

```

```{r, fig.width=8, fig.height=6}
p1 <- RR_plot(ds=preds.age )
p1 + facet_wrap(~agec, scales='free')

```

or by age and race


```{r, fig.width=8, fig.height=6}

p1 <- obs_exp_plot(ds=preds.age.race.region[preds.age.race.region$source=='va' & preds.age.race.region$race_recode=='1',], xvar='date',yvar='N_deaths', groupvar='agec', colvar='agec', datemin='2018-01-01')

p1 + facet_grid(~agec, scales='free')

```

```{r, fig.width=8, fig.height=6}

p1 <- RR_plot(ds=preds.age.race.region[preds.age.race.region$source=='va' & preds.age.race.region$race_recode=='1',],  groupvar='agec', colvar='agec', datemin='2018-01-01') 


p1 + facet_grid(~agec, scales='free')

```

Age and region 
```{r, fig.width=8, fig.height=6}
p1 <- obs_exp_plot(ds=preds.age.region[preds.age.region$source=='cdc' & preds.age.region$agec !='Under 25 Years',], xvar='date',yvar='N_deaths', groupvar='agec', colvar='agec', datemin='2014-01-01')
p1 + facet_grid(agec~region, scales='free')

```

```{r, fig.width=8, fig.height=6}
p1 <- RR_plot(ds=preds.age.region[preds.age.region$source=='cdc',],  groupvar='agec', colvar='agec', datemin='2018-01-01') 
p1 + facet_grid(agec~region, scales='free')

```


Look at RR and excess rates by sex for VA vs CDC
```{r}


##FOR NOW< IGNORE MISSING RACE CATEGORY WHEN CALCULATING STD RATES


std.inc.whites <- preds.age.race.region[preds.age.race.region$race_recode == '1',] %>%
  group_by(source,date) %>%
  mutate(pop.prop2 = std.pop/sum(std.pop)) %>%
  summarize(std_excess_inc=sum(excess_inc_median*pop.prop2), check1=sum(pop.prop2)) %>%
  ungroup()
std.inc.whites

white.m <- reshape2::melt(preds.age.race.region[preds.age.race.region$race_recode == '1',c('date','source','sex','agec','region','RR_median','excess_inc_median')], id.vars=c('date','source','agec','sex','region'))

white.c <- reshape2::dcast(white.m, date+sex+region+agec~variable +source)


p0 <- ggplot(white.c,aes(x=RR_median_cdc, y=RR_median_va)) +
  geom_point() +
  theme_classic() +
      facet_wrap(~sex,  nrow=1) +
  geom_abline(slope=1, intercept=0)

p0

p0 <- ggplot(white.c,aes(x=excess_inc_median_cdc, y=excess_inc_median_va)) +
  geom_point() +
  theme_classic() +
      facet_wrap(~sex,  nrow=1) +
  geom_abline(slope=1, intercept=0)

p0
```

