---
title: "Compare excess death in va and CDC data"
author: "Dan Weinberger"
date: "10/29/2020"
output:
  html_document:
    df_print: paged
    html_document: null
    toc: yes
    toc_depth: 2
    toc_float: yes
  word_document:
    toc: yes
    toc_depth: '2'
  pdf_document: 
    keep_tex:  true
params:
  agg.level: 'state'
  n.days.filter: 20
  web.version: FALSE
  extrap.date: '2020-01-26'
  count.start.date: '2020-03-01'
  end.data.date: '2020-09-05'
---

```{r setup, include = F}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo=F,
  warning=FALSE, 
  message=FALSE,
  comment = "#>",
  dev=c('png','pdf'),
  fig.path='./figures/',
  gganimate = list(
    nframes = 50)
)

library(readxl)
library(cdcfluview)
library(reshape2)
library(ggplot2)
library(lubridate)
library(RColorBrewer)
library(plotly)
library(MMWRweek)
library(readr)
library(rjson)
library(parallel)
library(htmlTable)
library(RSocrata)
library(pdftools)
library(readr)
library(patchwork)
library(abind)
library(INLA)
library(gsubfn)
library(dplyr)
library(RCurl)
library(dplyr)
library(tidyverse)
library(gifski)
library(gganimate)
library(shiny)
library(INLA)
library(lme4)

library(pbapply)
#library(jsonlite)
set.seed(123)

source('./R/read_dependent_scripts.R')

```


```{r}
cdc<- readRDS('./outputs/summary_list_cdc.rds')
va.full <- readRDS('./outputs/confidential/outputs_full/summary_list_va.rds')
va.users <- readRDS('./outputs/confidential/outputs_users/summary_list_va.rds')

```

```{r}
plot(va.users$preds.age_race$excess_inc_median)

ggplot(va.users$preds.age_race, aes(x=date, y=excess_inc_median)) +
  geom_line() +
  theme_classic()+
  facet_grid(agec~race_recode, scales='free')

plot(va.users$preds.age_race$excess_inc_median)

ggplot(cdc$preds.age_race, aes(x=date, y=pop)) +
  geom_line() +
  theme_classic()+
  facet_wrap(agec~race_recode, scales='free')
```



## Observed vs expected CDC 

```{r}
cdc$fit.plots$p1
```

```{r}
plot(cdc$preds.age$date, cdc$preds.age$pop)
```


## Observed vs expected VA (full)

```{r}
va.full$fit.plots$p1

```
## Observed vs expected VA (active enrollees)

```{r}
va.users$fit.plots$p1

```


```{r}
va.full$fit.plots$p5
cdc$fit.plots$p5

```


## Changes by quarter in 2020 compared with expected values in the 3 populations 
```{r, fig.width=8, fig.height=4}

va.users$preds.age$source <- 'va.users'

va.full$preds.age$source <- 'va.full'

preds.age <- bind_rows(cdc$preds.age, va.full$preds.age, va.users$preds.age)

 p1 <- RR_plot(ds=preds.age ,datemin='2020-01-01', add.CIs=F) + 
    facet_grid(~agec, scales='fixed')
 
 p1
```

## Changes by quarter in 2020 compared with expected values in the 3 populations 
By region and age

```{r, fig.width=8, fg.height=12}

va.users$preds.age.race.region$source <- 'va.users'
va.full$preds.age.race.region$source <- 'va.full'

preds.age.race.region <- bind_rows(cdc$preds.age.race.region, va.users$preds.age.race.region,va.full$preds.age.race.region)

 p2 <- RR_plot(ds=preds.age.race.region[preds.age.race.region$race_recode==1 & preds.age.race.region$sex=='M',] ,datemin='2020-01-01',add.CIs=F) + 
    facet_grid(region~agec, scales='fixed')
 
 p2
```

## Population-standardized excess incidence

```{r}
va.users$std.inc$source <- 'va.users'
va.full$std.inc$source <- 'va.full'

std.inc <- bind_rows(va.users$std.inc, va.full$std.inc, cdc$std.inc)
std.inc$std_excess_inc <- round(std.inc$std_excess_inc, 1)

std.inc.c <- dcast(std.inc, date~source, value.var='std_excess_inc')
std.inc.c
```

## Excess deaths per 100,000 by age group

```{r}

excess.ds <- preds.age %>%
  select(source, agec, date, starts_with('excess_inc')) %>%
  mutate(excess_inc = paste0(round(excess_inc_median, 1) , ', (' ,round(excess_inc_lcl, 1) , ', ', round(excess_inc_ucl, 1) , ')'  )    )

excess.ds.m <- melt(excess.ds[,c('source','agec','date','excess_inc')], id.vars=c('source','agec','date'))
excess.ds.c <- dcast(excess.ds.m, agec+ date ~ source)

htmlTable(excess.ds.c[excess.ds.c$date>='2020-01-01',c('date','cdc','va.full','va.users')],
          n.rgroup=c(4,4,4,4,4), rgroup=unique(excess.ds.c$agec), rnames=F,
          caption='Table 2: Excess Deaths per 100,000 population')
```


## Excess deaths per 100,000 in the Northeast among white males

```{r}

excess.ds.age.region <- preds.age.race.region %>%
  select(source, agec,region,sex,race_recode, date, starts_with('excess_inc')) %>%
  mutate(excess_inc = paste0(round(excess_inc_median, 1) , ', (' ,round(excess_inc_lcl, 1) , ', ', round(excess_inc_ucl, 1) , ')'  )    )

excess.ds.age.region.m <- melt(excess.ds.age.region[,c('source','agec','sex','race_recode','region','date','excess_inc')], id.vars=c('source','agec','date', 'sex', 'region','race_recode'))

excess.ds.age.region.c <- dcast(excess.ds.age.region.m, agec+ sex+region + date +race_recode ~ source)

htmlTable(excess.ds.age.region.c[excess.ds.age.region.c$date>='2020-01-01' & excess.ds.age.region.c$race_recode==1 & excess.ds.age.region.c$sex=='M' & excess.ds.age.region.c$region=='Northeast',c('date','cdc','va.full','va.users')],
          n.rgroup=c(4,4,4,4,4), rgroup=unique(excess.ds.c$agec), rnames=F,
          caption='Table 2: Excess Deaths per 100,000 population in the Northeast, White, males')


```


